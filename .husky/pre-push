#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8

RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
RESET=$(tput sgr0)

echo "🚀 Preparing to push changes..."
echo "----------------------------------"

echo "🧪 Running unit tests..."
dotnet test --no-restore --logger "trx;LogFileName=TestResults.trx" --results-directory TestResults

if [ $? -eq 0 ]; then
    SUMMARY=$(dotnet test --no-build --no-restore)
    echo "${GREEN}✅ Tests Completed Successfully!${RESET}"
    echo "${YELLOW}📊 Test Summary:${RESET}"
    echo "$SUMMARY" | findstr "Total"
    echo "$SUMMARY" | findstr "Passed"
    echo "$SUMMARY" | findstr "Failed"
    echo "$SUMMARY" | findstr "Skipped"
    echo "----------------------------------"
    echo "🚀 Ready to push!"
    exit 0
else
    SUMMARY=$(dotnet test --no-build --no-restore)
    echo "${RED}❌ Some tests failed!${RESET}"
    echo "${YELLOW}📊 Test Summary:${RESET}"
    echo "$SUMMARY" | findstr "Total"
    echo "$SUMMARY" | findstr "Passed"
    echo "$SUMMARY" | findstr "Failed"
    echo "$SUMMARY" | findstr "Skipped"
    echo "----------------------------------"
    echo "${RED}❌ Push blocked due to test failures${RESET}"
    exit 1
fi
