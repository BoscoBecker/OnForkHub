#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8

RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
RESET=$(tput sgr0)

echo "üöÄ Preparing to push changes..."
echo "----------------------------------"

echo "üß™ Running unit tests..."
TEST_OUTPUT=$(dotnet test --no-restore --verbosity normal)
TEST_RESULT=$?

# Extract relevant information
TOTAL_TESTS=$(echo "$TEST_OUTPUT" | grep "Total tests:" | sed 's/Total tests: //')
PASSED_TESTS=$(echo "$TEST_OUTPUT" | grep "Passed:" | sed 's/Passed: //')
FAILED_TESTS=$(echo "$TEST_OUTPUT" | grep "Failed:" | sed 's/Failed: //')
SKIPPED_TESTS=$(echo "$TEST_OUTPUT" | grep "Skipped:" | sed 's/Skipped: //')

echo "----------------------------------"
if [ $TEST_RESULT -eq 0 ]; then
    echo "${GREEN}‚úÖ Tests Completed Successfully!${RESET}"
    echo "${YELLOW}üìä Test Summary:${RESET}"
    echo "   üìà Total Tests: $TOTAL_TESTS"
    echo "   ${GREEN}‚úÖ Passed: $PASSED_TESTS${RESET}"
    [ ! -z "$SKIPPED_TESTS" ] && echo "   ${YELLOW}‚è≠Ô∏è  Skipped: $SKIPPED_TESTS${RESET}"
    echo "----------------------------------"
    echo "üöÄ Ready to push!"
else
    echo "${RED}‚ùå Some tests failed!${RESET}"
    echo "${YELLOW}üìä Test Summary:${RESET}"
    echo "   üìà Total Tests: $TOTAL_TESTS"
    echo "   ${GREEN}‚úÖ Passed: $PASSED_TESTS${RESET}"
    echo "   ${RED}‚ùå Failed: $FAILED_TESTS${RESET}"
    [ ! -z "$SKIPPED_TESTS" ] && echo "   ${YELLOW}‚è≠Ô∏è  Skipped: $SKIPPED_TESTS${RESET}"
    echo "----------------------------------"
    echo "${RED}‚ùå Push blocked due to test failures${RESET}"
    # Show failure details
    echo "\n${YELLOW}Failure Details:${RESET}"
    echo "$TEST_OUTPUT" | grep -A 5 "Failed"
    exit 1
fi
